/ **
  @page FWupgrade_Standalone Приложение для обновления прошивки хоста USB
  
  @verbatim
  ******************** (C) АВТОРСКИЕ ПРАВА 2017 STMicroelectronics *******************
  * @ файл USB_Host / FWupgrade_Standalone / readme.txt
  * @author Команда разработчиков MCD
  * @ краткое описание приложения обновления прошивки USB-хоста
  ************************************************* ****************************
 
@par Описание приложения

Приложение для обновления прошивки или программирование в приложении (IAP) - это
функция, которая позволяет пользовательскому приложению стирать и записывать на встроенную флэш-память
объем памяти.

Это типичное приложение о том, как использовать периферийное устройство STM32F4xx USB OTG Host для обновления прошивки.
приложение или IAP, позволяющее пользователю стирать и записывать во встроенную флэш-память.

В начале основной программы вызывается функция HAL_Init () для сброса всех периферийных устройств,
инициализировать интерфейс Flash и systick. Пользователю предоставляется SystemClock_Config ()
функция для настройки системных часов (SYSCLK) для работы на частоте 168 МГц. USB-модуль Full Speed ​​(FS) использует
внутренне тактовая частота 48 МГц, которая генерируется встроенной ФАПЧ. В режиме высокой скорости (HS)
Тактовая частота USB (60 МГц) управляется ULPI.

Стоит отметить, что системные часы (SYSCLK) можно настроить в зависимости от используемого USB-ядра:
 - SYSCLK установлен на 168 МГц: для ядра FS, поскольку для использования встроенного физического уровня требуется частота 48 МГц,
                             достигается только при установке системных часов на 168 МГц.
 - SYSCLK установлен на 180 МГц: только для HS Core, поскольку встроенный PHY не используется.

Это приложение использует USB-хост для:
 - ЗАГРУЗИТЬ: читает файл с определенным образом (.bin) «DOWNLOAD_FILENAME» с флэш-накопителя и записывает его.
             во встроенную флэш-память.
 - ЗАГРУЗКА: считывает всю встроенную флэш-память и сохраняет ее содержимое в файл с заданным именем.
             «UPLOAD_FILENAME» на флешке.
 - JUMP: выполняет код пользователя по указанному начальному адресу приложения пользователя «APPLICATION_ADDRESS».
             Изображение, которое должно быть определено с этого адреса флэш-памяти: 0x0800C000
  
@note Необходимо соблюдать осторожность при использовании HAL_Delay (), эта функция обеспечивает точную задержку (в миллисекундах)
      на основе переменной, увеличиваемой в SysTick ISR. Это означает, что если HAL_Delay () вызывается из
      периферийный процесс ISR, тогда прерывание SysTick должно иметь более высокий приоритет (численно ниже)
      чем периферийное прерывание. В противном случае процесс ISR вызывающего абонента будет заблокирован.
      Чтобы изменить приоритет прерывания SysTick, вы должны использовать функцию HAL_NVIC_SetPriority ().
      
@note Приложению необходимо обеспечить, чтобы временная база SysTick всегда была установлена ​​на 1 миллисекунду.
      для правильной работы HAL.

Для получения дополнительных сведений о библиотеке USB-хоста STM32Cube, пожалуйста, обратитесь к UM1720
"Библиотека хоста USB STM32Cube".


@par Конфигурация библиотеки USB

Чтобы выбрать соответствующее ядро ​​USB для работы, пользователь должен добавить следующие макроопределения в
препроцессор компилятора (уже сделано в предварительно настроенных проектах, поставляемых с этим приложением):
      - «USE_USB_HS» при использовании ядра USB High Speed ​​(HS)
      - «USE_USB_FS» при использовании ядра USB Full Speed ​​(FS)

Пользовательское приложение (двоичный файл), загружаемое во флэш-память с помощью обновления прошивки
приложение построено со следующими параметрами конфигурации:
- Установите адрес загрузки программы на APPLICATION_ADDRESS в файле компоновщика инструментальной цепочки.
- Переместите векторную таблицу на адрес APPLICATION_ADDRESS, используя определение VECT_TAB_OFFSET
внутри файла system_stm32f4xx.c.

@par Ключевые слова

Обновление прошивки, USB-хост, IAP, двоичный

@par Содержимое каталога

  - USB_Host / FWupgrade_Standalone / Src / main.c Основная программа
  - Реализация драйвера USB_Host / FWupgrade_Standalone / Src / usbh_diskio_dma.c FatFS usbh diskio
  - USB_Host / FWupgrade_Standalone / Src / system_stm32f4xx.c Файл конфигурации системных часов STM32F4xx
  - USB_Host / FWupgrade_Standalone / Src / stm32f4xx_it.c Обработчики прерываний
  - USB_Host / FWupgrade_Standalone / Src / iap_menu.c Конечный автомат IAP
  - USB_Host / FWupgrade_Standalone / Src / usbh_conf.c Общая конфигурация драйвера низкого уровня
  - USB_Host / FWupgrade_Standalone / Src / command.c Командные функции IAP
  - USB_Host / FWupgrade_Standalone / Src / flash_if.c Функции слоя Flash
  - USB_Host / FWupgrade_Standalone / Src / usbh_diskio.c Интерфейс USB diskio для FatFs
  - USB_Host / FWupgrade_Standalone / Inc / main.h Главный файл заголовка программы
  - USB_Host / FWupgrade_Standalone / Inc / usbh_diskio_dma.h FatFS usbh файл заголовка драйвера diskio
  - USB_Host / FWupgrade_Standalone / Inc / stm32f4xx_it.h Заголовочный файл обработчиков прерываний
  - USB_Host / FWupgrade_Standalone / Inc / command.h Файл заголовка командных функций IAP
  - USB_Host / FWupgrade_Standalone / Inc / flash_if.h Файл заголовка функций уровня Flash
  - USB_Host / FWupgrade_Standalone / Inc / stm32f4xx_hal_conf.h файл конфигурации HAL
  - USB_Host / FWupgrade_Standalone / Inc / usbh_conf.h Файл конфигурации драйвера USB-хоста
  - USB_Host / FWupgrade_Standalone / Inc / ffconf.h Файл конфигурации модуля FatFs
  
  - USB_Host / FWupgrade_Standalone / Двоичный /
    Эта папка содержит изображения, которые могут быть загружены и запущены приложением обновления FW:
    - STM324xG_EVAL_SysTick.bin
    - STM324xG_EVAL_USBH_MSC_FS.bin
    - STM324xG_EVAL_USBH_MSC_HS.bin
    

@par Аппаратно-программная среда

  - Это приложение работает на устройствах STM32F407xx / STM32F417xx.
    
  - Это приложение было протестировано с STMicroelectronics STM324xG-EVAL RevC
    оценочные платы и могут быть легко адаптированы к любому другому поддерживаемому устройству
    и совет по развитию.

  - Настройка STM324xG-EVAL RevC
    - Подключите USB- флеш к плате STM324xG-EVAL через разъем USB micro A-Male.
      to A-Female 'кабель к разъему:
      - CN9: для использования USB High Speed ​​(HS) со встроенным PHY (U8)
             Убедитесь, что перемычка JP31 подходит
      - CN8: для использования USB Full Speed ​​(FS)


@par Как им пользоваться?

Чтобы программа заработала, необходимо сделать следующее:
 - Откройте предпочитаемый набор инструментов
 - Восстановите все файлы и загрузите изображение в целевую память.
 - На панели инструментов рабочей области выберите конфигурацию проекта:
   - STM324xG-EVAL_USBH-HS: для настройки проекта для устройств STM32F4xx, использующих периферийное устройство USB OTG HS
   - STM324xG-EVAL_USBH-FS: для настройки проекта для устройств STM32F4xx, использующих периферийное устройство USB OTG FS
 - Чтобы запустить приложение, выполните следующие действия:

1. Загрузите двоичный образ пользовательской программы в корневой каталог USB-накопителя. Вы можете использовать
   предоставил двоичные образы в папке USB_Host / FWupgrade_Standalone / Binary.
   Бинарный файл следует переименовать в «image.bin».

2. Запрограммируйте приложение обновления прошивки во внутреннюю флэш-память.
   а. Откройте проект (в разделе USB_Host / FWupgrade_Standalone) с помощью предпочитаемой вами цепочки инструментов.
   б. Скомпилируйте и загрузите проект в целевую память и запустите проект.

После сброса платы и в зависимости от состояния кнопки Key:
   1. Клавиша нажата: запускается приложение обновления прошивки.
   2. Клавиша не нажата: будет выполнена проверка начального адреса пользовательского приложения, и будет выполнено одно из
      выполняются следующие процессы:
      - Доступна таблица векторных данных пользователя: приложение пользователя выполняется.
      - Таблица векторов пользователей недоступна: выполняется приложение обновления прошивки.

Во время выполнения приложения обновления прошивки происходит непрерывная проверка нажатой кнопки Key.
состояние время. В зависимости от времени состояния кнопки Key выполняется один из следующих процессов:
 - Если при запуске прошивки кнопка Key удерживается более 3 секунд:
   Команда UPLOAD будет выполнена сразу после завершения выполнения команды DOWNLOAD.
 - Если при запуске прошивки кнопка Key удерживается менее 3 секунд:
   Выполняется только команда DOWNLOAD.

Светодиоды платы STM32 Eval могут использоваться для отслеживания статуса приложения:
 - Красный светодиод мигает в бесконечном цикле
-> Ошибка: USB-ключ отключен.

 - Красный светодиод мигает бесконечным циклом, а оранжевый / синий светодиоды горят
-> Ошибка: ошибка программирования Flash.

 - Красный светодиод мигает бесконечным циклом, а зеленый светодиод горит.
-> Ошибка: загрузка завершена, USB-ключ отключен.

 - Красный светодиод мигает бесконечным циклом, а синий / оранжевый / зеленый светодиоды горят
-> Ошибка: двоичный файл недоступен

 - Красный / синий / оранжевый светодиоды мигают в бесконечном цикле
-> Ошибка: ограничение размера буфера, превышает 32 КБ

 - Красный светодиод непрерывно мигает, а синий светодиод горит.
-> Ошибка: нет доступного объема флэш-памяти для загрузки двоичного файла.

 - Красный / оранжевый светодиоды мигают в бесконечном цикле
-> Ошибка: ошибка стирания флеш-памяти.

 - Красный / синий светодиоды горят
-> Состояние ЗАГРУЗКИ проверено, и пользователь должен отпустить кнопку Key.

 - Горит синий светодиод
-> СКАЧАТЬ продолжается.

 - Горят оранжевый / красный светодиоды
-> ЗАГРУЗКА выполнена, ЗАГРУЗКА продолжается.

 - Горит оранжевый / синий светодиоды
-> ЗАГРУЗКА продолжается.

 - Красный светодиод непрерывно мигает, а оранжевый светодиод горит.
-> Защита USB-ключа от считывания включена.

 - Горит зеленый светодиод
-> ЗАГРУЗКА и ЗАГРУЗКА выполнены успешно; и MCU ждет, пока вы не нажмете кнопку Key перед
      выполнение команды JUMP.
  
 * <h3> <center> & copy; АВТОРСКИЕ ПРАВА STMicroelectronics </center> </h3>
 * /